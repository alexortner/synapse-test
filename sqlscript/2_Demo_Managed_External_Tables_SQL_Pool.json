{
	"name": "2_Demo_Managed_External_Tables_SQL_Pool",
	"properties": {
		"content": {
			"query": "-- #######################################################################\n-- Case 1: Register external Table in SQL Pool Metastore\n-- #######################################################################\n\n\n-- Create external table\nCREATE EXTERNAL TABLE dbo.airports_ext (\n\t[airport_id] int,\n\t[iata] nvarchar(4000),\n\t[icao] nvarchar(4000),\n\t[name] nvarchar(4000),\n\t[address] nvarchar(4000),\n\t[website] nvarchar(4000),\n\t[bio] nvarchar(4000),\n\t[city_id] nvarchar(4000),\n\t[city_name] nvarchar(4000),\n\t[country_id] nvarchar(4000),\n\t[country_code] nvarchar(4000),\n\t[country_name] nvarchar(4000),\n\t[region_id] nvarchar(4000),\n\t[region_code] nvarchar(4000),\n\t[region_name] nvarchar(4000),\n\t[latitude] nvarchar(4000),\n\t[longitude] nvarchar(4000),\n\t[data_url] nvarchar(4000),\n\t[dap_hash] nvarchar(4000),\n\t[__insertTimestamp] nvarchar(4000),\n\t[__loadTimestampCurated] nvarchar(4000)\n\t)\n\tWITH (\n\tLOCATION = 'airport.delta',\n\tDATA_SOURCE = lhtDataSource,\n\tFILE_FORMAT = SynapseParquetFormat\n\t)\nGO\n\n\n\n-- Check Data --------------------------------------------------------------\nSELECT \n    TOP 5 name,city_name, country_name, iata, icao \nFROM dbo.airports_ext\nWHERE country_code = 'DE'\nORDER BY city_name\n\n\n\n\n\n\n-- #######################################################################\n-- Case 2: Create new table in external storage\n-- #######################################################################\n\nCREATE EXTERNAL TABLE dbo.airports_de_ext\nWITH (\n    LOCATION = 'external_tables/airports_de',\n    DATA_SOURCE = lhtDataSource,\n    FILE_FORMAT = SynapseParquetFormat\n)\nAS\nSELECT name,city_name, country_name, iata, icao \nFROM dbo.airports_ext\nWHERE country_code = 'DE'\n\n\n\n-- Check Data --------------------------------------------------------------\nSELECT \n    TOP 5 * FROM dbo.airports_de_ext\nORDER BY city_name\n\n\n\n\n-- #######################################################################\n-- Case 3: Create managed table\n-- #######################################################################\nCREATE TABLE dbo.airports_fr_int\nWITH\n(\n    DISTRIBUTION = ROUND_ROBIN,         -- How the data are distributed over nodes (ROUND_ROBIN, HASH,REPLICATE)\n    CLUSTERED COLUMNSTORE INDEX         -- How the index is organised (CLUSTERED COLUMNSTORE, CLUSTERED INDEX, HEAP)\n)\nAS\nSELECT name,city_name, country_name, iata, icao \nFROM dbo.airports_ext\nWHERE country_code = 'FR'\n\n\n-- Check Data --------------------------------------------------------------\nSELECT \n    TOP 5 * FROM dbo.airports_fr_int\nORDER BY city_name\n\n\n-- #######################################################################\n-- Case 4: Create a view over a table \n-- #######################################################################\nCREATE VIEW dbo.airports_us_v\nAS\nSELECT name, city_name, country_name, iata, icao\nFROM dbo.airports_ext\nWHERE country_code = 'US';\n\n\n-- Check Data --------------------------------------------------------------\nSELECT \n    TOP 5 * FROM dbo.airports_us_v\nORDER BY city_name\n\n\n\n\n\n\n-- #######################################################################\n-- Case 5: Create parameterized stored procedure\n-- #######################################################################\nCREATE PROCEDURE dbo.GetAirportsByCountry\n    @CountryCode NVARCHAR(10)  -- Parameter to filter by country\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    SELECT TOP 5 name, city_name, country_name, iata, icao\n    FROM dbo.airports_ext\n    WHERE country_code = @CountryCode\n    ORDER BY city_name;\nEND;\nGO\n\n\nEXEC dbo.GetAirportsByCountry @CountryCode = 'US';  -- For US airports\n\nEXEC dbo.GetAirportsByCountry @CountryCode = 'DE';  -- For Germany airports\n\nEXEC dbo.GetAirportsByCountry @CountryCode = 'FR';  -- For France airports\n\n\n\n-- #######################################################################\n-- Compare DROP internal and external table\n-- #######################################################################\n\n-- managed tables all data is deleted\nDROP TABLE dbo.airports_fr_int\n\n-- external tables only the reference is removed, data still remains in storage\nDROP EXTERNAL TABLE dbo.airports_de_ext\nDROP EXTERNAL TABLE dbo.airports_ext\n\nDROP VIEW dbo.airports_us_v\nDROP PROCEDURE dbo.GetAirportsByCountry;\n\n\nSELECT * FROM dbo.airport\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "SQL Pool with Metatore",
				"poolName": "SQL Pool with Metatore"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}