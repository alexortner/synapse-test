{
	"name": "1_Demo_Files_Metastore_Spark",
	"properties": {
		"nbformat": 4,
		"nbformat_minor": 2,
		"bigDataPool": {
			"referenceName": "Sparkpool01",
			"type": "BigDataPoolReference"
		},
		"sessionProperties": {
			"driverMemory": "28g",
			"driverCores": 4,
			"executorMemory": "28g",
			"executorCores": 4,
			"numExecutors": 2,
			"runAsWorkspaceSystemIdentity": false,
			"conf": {
				"spark.dynamicAllocation.enabled": "false",
				"spark.dynamicAllocation.minExecutors": "2",
				"spark.dynamicAllocation.maxExecutors": "2",
				"spark.autotune.trackingId": "fb24d0a6-bf25-4a26-a4f0-da2442485cb8"
			}
		},
		"metadata": {
			"saveOutput": true,
			"synapse_widget": {
				"version": "0.1",
				"state": {
					"5a75348a-7520-4214-9320-4f91c659fa8b": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "2211",
										"1": "AOC",
										"2": "EDAC",
										"3": "Altenburg Nobitz Airport",
										"4": "",
										"5": "http://www.leipzig-altenburg-airport.de/index.php?id=2",
										"6": "",
										"7": "2133",
										"8": "Altenburg",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "50.9816666667",
										"16": "12.5061111111",
										"17": "https://centreforaviation.com/data/profiles/airports/altenburg-nobitz-airport-aoc",
										"18": "7d432d825b58665cc2f0e54b0c00e990dbfb2178888d8f29592e9bbdb4650c5e",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3905",
										"1": "BER",
										"2": "EDDB",
										"3": "Berlin Brandenburg Airport",
										"4": "",
										"5": "http://www.berlin-airport.de/en/index.php",
										"6": "<p>Berlin Brandenburg Airport is located in Sch&ouml;nefeld, 18 kilometres south of Berlin, Germany. The facility was initially scheduled to open 2011, replacing all three airports in Berlin: Tempelhof, Tegel and Sch&ouml;nefeld. Construction work began on 05-Sep-2006.</p>\r\n<p>Berlin Brandenburg Airport officially came online on 31-Oct-2020, replacing Berlin Schoenefeld, which officially became BER T5 and had its SXF code removed on 25-Oct-2020. Berlin Tegel Airport handled its final commercial service on 08-Nov-2020, after which all traffic in Berlin became centralised at BER.</p>",
										"7": "237",
										"8": "Berlin",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "52.364694515525",
										"16": "13.510812520981",
										"17": "https://centreforaviation.com/data/profiles/airports/berlin-brandenburg-airport-ber",
										"18": "511fdeb7fb164534ed43f7caa81692de46fc7aa382974423031e68f01bc59079",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3916",
										"1": "BMK",
										"2": "EDWR",
										"3": "Borkum Airport",
										"4": "",
										"5": "http://www.borkum.de/DE/service/anreise/Anreise_Luftweg.php",
										"6": "",
										"7": "3773",
										"8": "Borkum",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "53.595351",
										"16": "6.712595999999962",
										"17": "https://centreforaviation.com/data/profiles/airports/borkum-airport-bmk",
										"18": "cc90a11d4385a283e1ce149dc5f8bca8253cee6acc4a35d07dda677aad77b599",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3782",
										"1": "BWE",
										"2": "EDVE",
										"3": "Braunschweig-Wolfsburg Airport",
										"4": "Lilienthalplatz 5 \r\n38108 Braunschweig\r\nGermany",
										"5": "http://www.flughafen-braunschweig-wolfsburg.de/",
										"6": "<p>Braunschweig-Wolfsburg Airport serves the cities of Brunswick and Wolfsburg, in Northern Central Germany.</p>",
										"7": "3660",
										"8": "Braunschweig/Wolfsburg",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "52.3193013",
										"16": "10.5532552",
										"17": "https://centreforaviation.com/data/profiles/airports/braunschweig-wolfsburg-airport-bwe",
										"18": "f8300bbc90c3775db03c701b0d4826f1dae06c99cb061cfe7c4f1998b66ef651",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "1303",
										"1": "BRE",
										"2": "EDDW",
										"3": "Bremen Airport Hans Koschnick",
										"4": "Postfach 28 61 52\r\n28361 Bremen\r\nGermany",
										"5": "https://www.bremen-airport.com/",
										"6": "<p><span>Bremen Airport Hans Koschnick</span> served the city of Bremen, Germany. A variety of European LCCs and full-service airlines operate scheduled services at Bremen Airport, which connect passengers to all major business centres across Europe. LCCs also operate service regular service to holiday destinations around Europe and the Mediterranean basin.</p>",
										"7": "1258",
										"8": "Bremen",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "53.0475",
										"16": "8.78666666667",
										"17": "https://centreforaviation.com/data/profiles/airports/bremen-airport-hans-koschnick-bre",
										"18": "d93c2fdcd78442e485d9f2c201ac60fcf7c4c29bb86f6695868ef32df8867924",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "airport_id",
										"type": "int"
									},
									{
										"key": "1",
										"name": "iata",
										"type": "string"
									},
									{
										"key": "2",
										"name": "icao",
										"type": "string"
									},
									{
										"key": "3",
										"name": "name",
										"type": "string"
									},
									{
										"key": "4",
										"name": "address",
										"type": "string"
									},
									{
										"key": "5",
										"name": "website",
										"type": "string"
									},
									{
										"key": "6",
										"name": "bio",
										"type": "string"
									},
									{
										"key": "7",
										"name": "city_id",
										"type": "string"
									},
									{
										"key": "8",
										"name": "city_name",
										"type": "string"
									},
									{
										"key": "9",
										"name": "country_id",
										"type": "string"
									},
									{
										"key": "10",
										"name": "country_code",
										"type": "string"
									},
									{
										"key": "11",
										"name": "country_name",
										"type": "string"
									},
									{
										"key": "12",
										"name": "region_id",
										"type": "string"
									},
									{
										"key": "13",
										"name": "region_code",
										"type": "string"
									},
									{
										"key": "14",
										"name": "region_name",
										"type": "string"
									},
									{
										"key": "15",
										"name": "latitude",
										"type": "string"
									},
									{
										"key": "16",
										"name": "longitude",
										"type": "string"
									},
									{
										"key": "17",
										"name": "data_url",
										"type": "string"
									},
									{
										"key": "18",
										"name": "dap_hash",
										"type": "string"
									},
									{
										"key": "19",
										"name": "__insertTimestamp",
										"type": "string"
									},
									{
										"key": "20",
										"name": "__loadTimestampCurated",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala",
							"wranglerEntryContext": {
								"candidateVariableNames": [
									"df_from_file"
								],
								"dataframeType": "pyspark"
							}
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"1"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					},
					"f9d66bd9-447a-4d1e-bf6c-e4eebecf587f": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "2211",
										"1": "AOC",
										"2": "EDAC",
										"3": "Altenburg Nobitz Airport",
										"4": "",
										"5": "http://www.leipzig-altenburg-airport.de/index.php?id=2",
										"6": "",
										"7": "2133",
										"8": "Altenburg",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "50.9816666667",
										"16": "12.5061111111",
										"17": "https://centreforaviation.com/data/profiles/airports/altenburg-nobitz-airport-aoc",
										"18": "7d432d825b58665cc2f0e54b0c00e990dbfb2178888d8f29592e9bbdb4650c5e",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3905",
										"1": "BER",
										"2": "EDDB",
										"3": "Berlin Brandenburg Airport",
										"4": "",
										"5": "http://www.berlin-airport.de/en/index.php",
										"6": "<p>Berlin Brandenburg Airport is located in Sch&ouml;nefeld, 18 kilometres south of Berlin, Germany. The facility was initially scheduled to open 2011, replacing all three airports in Berlin: Tempelhof, Tegel and Sch&ouml;nefeld. Construction work began on 05-Sep-2006.</p>\r\n<p>Berlin Brandenburg Airport officially came online on 31-Oct-2020, replacing Berlin Schoenefeld, which officially became BER T5 and had its SXF code removed on 25-Oct-2020. Berlin Tegel Airport handled its final commercial service on 08-Nov-2020, after which all traffic in Berlin became centralised at BER.</p>",
										"7": "237",
										"8": "Berlin",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "52.364694515525",
										"16": "13.510812520981",
										"17": "https://centreforaviation.com/data/profiles/airports/berlin-brandenburg-airport-ber",
										"18": "511fdeb7fb164534ed43f7caa81692de46fc7aa382974423031e68f01bc59079",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3916",
										"1": "BMK",
										"2": "EDWR",
										"3": "Borkum Airport",
										"4": "",
										"5": "http://www.borkum.de/DE/service/anreise/Anreise_Luftweg.php",
										"6": "",
										"7": "3773",
										"8": "Borkum",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "53.595351",
										"16": "6.712595999999962",
										"17": "https://centreforaviation.com/data/profiles/airports/borkum-airport-bmk",
										"18": "cc90a11d4385a283e1ce149dc5f8bca8253cee6acc4a35d07dda677aad77b599",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "3782",
										"1": "BWE",
										"2": "EDVE",
										"3": "Braunschweig-Wolfsburg Airport",
										"4": "Lilienthalplatz 5 \r\n38108 Braunschweig\r\nGermany",
										"5": "http://www.flughafen-braunschweig-wolfsburg.de/",
										"6": "<p>Braunschweig-Wolfsburg Airport serves the cities of Brunswick and Wolfsburg, in Northern Central Germany.</p>",
										"7": "3660",
										"8": "Braunschweig/Wolfsburg",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "52.3193013",
										"16": "10.5532552",
										"17": "https://centreforaviation.com/data/profiles/airports/braunschweig-wolfsburg-airport-bwe",
										"18": "f8300bbc90c3775db03c701b0d4826f1dae06c99cb061cfe7c4f1998b66ef651",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									},
									{
										"0": "1303",
										"1": "BRE",
										"2": "EDDW",
										"3": "Bremen Airport Hans Koschnick",
										"4": "Postfach 28 61 52\r\n28361 Bremen\r\nGermany",
										"5": "https://www.bremen-airport.com/",
										"6": "<p><span>Bremen Airport Hans Koschnick</span> served the city of Bremen, Germany. A variety of European LCCs and full-service airlines operate scheduled services at Bremen Airport, which connect passengers to all major business centres across Europe. LCCs also operate service regular service to holiday destinations around Europe and the Mediterranean basin.</p>",
										"7": "1258",
										"8": "Bremen",
										"9": "7",
										"10": "DE",
										"11": "Germany",
										"12": "2",
										"13": "EU1",
										"14": "Europe: Western Europe",
										"15": "53.0475",
										"16": "8.78666666667",
										"17": "https://centreforaviation.com/data/profiles/airports/bremen-airport-hans-koschnick-bre",
										"18": "d93c2fdcd78442e485d9f2c201ac60fcf7c4c29bb86f6695868ef32df8867924",
										"19": "2024-08-21 07:47:12",
										"20": "2025-02-27 09:56:01"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "airport_id",
										"type": "int"
									},
									{
										"key": "1",
										"name": "iata",
										"type": "string"
									},
									{
										"key": "2",
										"name": "icao",
										"type": "string"
									},
									{
										"key": "3",
										"name": "name",
										"type": "string"
									},
									{
										"key": "4",
										"name": "address",
										"type": "string"
									},
									{
										"key": "5",
										"name": "website",
										"type": "string"
									},
									{
										"key": "6",
										"name": "bio",
										"type": "string"
									},
									{
										"key": "7",
										"name": "city_id",
										"type": "string"
									},
									{
										"key": "8",
										"name": "city_name",
										"type": "string"
									},
									{
										"key": "9",
										"name": "country_id",
										"type": "string"
									},
									{
										"key": "10",
										"name": "country_code",
										"type": "string"
									},
									{
										"key": "11",
										"name": "country_name",
										"type": "string"
									},
									{
										"key": "12",
										"name": "region_id",
										"type": "string"
									},
									{
										"key": "13",
										"name": "region_code",
										"type": "string"
									},
									{
										"key": "14",
										"name": "region_name",
										"type": "string"
									},
									{
										"key": "15",
										"name": "latitude",
										"type": "string"
									},
									{
										"key": "16",
										"name": "longitude",
										"type": "string"
									},
									{
										"key": "17",
										"name": "data_url",
										"type": "string"
									},
									{
										"key": "18",
										"name": "dap_hash",
										"type": "string"
									},
									{
										"key": "19",
										"name": "__insertTimestamp",
										"type": "string"
									},
									{
										"key": "20",
										"name": "__loadTimestampCurated",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala",
							"wranglerEntryContext": {
								"candidateVariableNames": [
									"df_from_table"
								],
								"dataframeType": "pyspark"
							}
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"1"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					}
				}
			},
			"enableDebugMode": false,
			"language_info": {
				"name": "python"
			},
			"a365ComputeOptions": {
				"id": "/subscriptions/09a38f01-eb6d-4b29-8759-eaac6c6e0933/resourceGroups/lht_workshop/providers/Microsoft.Synapse/workspaces/lht-workshop-prepration/bigDataPools/Sparkpool01",
				"name": "Sparkpool01",
				"type": "Spark",
				"endpoint": "https://lht-workshop-prepration.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/Sparkpool01",
				"auth": {
					"type": "AAD",
					"authResource": "https://dev.azuresynapse.net",
					"authHeader": null
				},
				"sparkVersion": "3.4",
				"nodeCount": 10,
				"cores": 4,
				"memory": 28,
				"extraHeader": null
			},
			"sessionKeepAliveTimeout": 30
		},
		"cells": [
			{
				"cell_type": "code",
				"source": [
					"import pyspark.sql.functions as f\n",
					"bucket = \"abfss://lht@lhtdata.dfs.core.windows.net/\""
				],
				"execution_count": 2
			},
			{
				"cell_type": "code",
				"source": [
					"%run helpers"
				],
				"execution_count": 3
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"### Check the data files on the storage "
				]
			},
			{
				"cell_type": "code",
				"source": [
					"# Look on the storage\n",
					"list_files_tree(f\"{bucket}\",0,0)"
				],
				"execution_count": 64
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"In Spark the three Level Namespace consists of \n",
					"* First Level = Catalog\n",
					"* Second Level = Database\n",
					"* Third Level = Table"
				]
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"### Check the catalog, database and tables in the metastore"
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- check which catalog is connected to Spark\n",
					"-- spark_catalog == lake database\n",
					"\n",
					"show CATALOGS"
				],
				"execution_count": 9
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"SHOW DATABASES in spark_catalog"
				],
				"execution_count": 17
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"### Load and Query data in different ways\n",
					"\n",
					"1. directly from file\n",
					"2. register existing file as external talbe\n",
					"3. create managed table and fill with data\n",
					"\n",
					""
				]
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"#### Read direct file read"
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"collapsed": false
				},
				"source": [
					"df_from_file = (spark\n",
					"    # read file\n",
					"    .read.format('delta').load('abfss://lht@lhtdata.dfs.core.windows.net/airport.delta')\n",
					"    # filter\n",
					"    .filter(f.col(\"country_code\")=='DE')\n",
					"    .sort(f.col(\"city_name\"))\n",
					"    .limit(5)\n",
					"    )\n",
					"\n",
					"\n",
					"display(df_from_file)"
				],
				"execution_count": 21
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"#### Read via table definition\n",
					""
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					}
				},
				"source": [
					"%%sql\n",
					"-- create new database with root storage in our storage containter\n",
					"CREATE DATABASE flight_data\n",
					"LOCATION 'abfss://lht@lhtdata.dfs.core.windows.net/flight_data'"
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"collapsed": false
				},
				"source": [
					"# current tables in database\n",
					"show_table_details(\"flight_data\")"
				],
				"execution_count": 28
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"##### Register existing Delta files as external table"
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- register existing delta file as a table with a new name\n",
					"CREATE EXTERNAL TABLE IF NOT EXISTS flight_data.airport_registered_from_spark\n",
					"USING DELTA\n",
					"LOCATION 'abfss://lht@lhtdata.dfs.core.windows.net/airport.delta';"
				],
				"execution_count": 31
			},
			{
				"cell_type": "code",
				"source": [
					"# current tables in database\n",
					"show_table_details(\"flight_data\")"
				],
				"execution_count": 32
			},
			{
				"cell_type": "code",
				"metadata": {
					"collapsed": false
				},
				"source": [
					"# pyspark - dataframe API\n",
					"df_from_table = (spark\n",
					"    # read table\n",
					"    .read.table(\"flight_data.airport_registered_from_spark\")\n",
					"    # filter\n",
					"    .filter(f.col(\"country_code\")=='DE')\n",
					"    .sort(f.col(\"city_name\"))\n",
					"    .limit(5)\n",
					"    )\n",
					"\n",
					"\n",
					"display(df_from_table)"
				],
				"execution_count": 33
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- spark sql api\n",
					"\n",
					"-- Read data from table defined in Metastore via Spark SQL\n",
					"SELECT\n",
					"    name,city_name, country_name, iata, icao \n",
					"FROM \n",
					"    flight_data.airport_registered_from_spark\n",
					"WHERE country_code = 'DE'\n",
					"ORDER BY city_name\n",
					"LIMIT 5"
				],
				"execution_count": 34
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"#### Create a new external table in some storage\n",
					"* this time a new external table is registered on a folder that is so far empty with no Delta file "
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- register new empty delta file on an external path\n",
					"CREATE EXTERNAL TABLE IF NOT EXISTS flight_data.airport_new_from_spark\n",
					"USING DELTA\n",
					"LOCATION 'abfss://lht@lhtdata.dfs.core.windows.net/external_tables/airport_new_from_spark.delta';"
				],
				"execution_count": 43
			},
			{
				"cell_type": "code",
				"source": [
					"# current tables in Metastore\n",
					"show_table_details(\"flight_data\")"
				],
				"execution_count": 44
			},
			{
				"cell_type": "code",
				"source": [
					"#%%sql\n",
					"#-- SELECT * FROM flight_data.airport_new_from_spark"
				],
				"execution_count": 48
			},
			{
				"cell_type": "code",
				"source": [
					"# Add ata to the empty created delta table\n",
					"(df_from_file.write\n",
					"  .format(\"delta\")\n",
					"  .mode(\"append\")\n",
					"  # the empty table has no schema, now we need to force it to overwrite it with the schea\n",
					"  .option(\"mergeSchema\", \"true\")\n",
					"  .saveAsTable(f\"flight_data.airport_new_from_spark\")\n",
					"  )"
				],
				"execution_count": 50
			},
			{
				"cell_type": "code",
				"source": [
					"# show table\n",
					"spark.sql(\"\"\"\n",
					"    SELECT\n",
					"        name,city_name, country_name, iata, icao \n",
					"    FROM \n",
					"        flight_data.airport_new_from_spark\n",
					"    WHERE country_code = 'DE'\n",
					"    ORDER BY city_name\n",
					"    LIMIT 5\n",
					"\"\"\").show()"
				],
				"execution_count": 52
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"#### Managed Tables\n",
					"\n",
					"For managed tables the data and the storage location is managed by the catalog. Here the table files are stored in the default location of the database we defined when creating the databae"
				]
			},
			{
				"cell_type": "code",
				"source": [
					"# Register it to the Lake Database metastore\n",
					"(df_from_file.write\n",
					"  .format(\"delta\")\n",
					"  .mode(\"overwrite\")\n",
					"  .saveAsTable(f\"flight_data.airport_managed\")\n",
					"  )"
				],
				"execution_count": 53
			},
			{
				"cell_type": "code",
				"source": [
					"# current tables in Metastore\n",
					"show_table_details(\"flight_data\")\n",
					"\n",
					"print(\"    \")\n",
					"print(\"####################################################################\")\n",
					"print(\"    \")\n",
					"\n",
					"list_files_tree(f\"{bucket}/flight_data\",0,1)"
				],
				"execution_count": 58
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- Read data from table defined in Metastore via Spark SQL\n",
					"SELECT\n",
					"    name,city_name, country_name, iata, icao \n",
					"FROM \n",
					"    flight_data.airport_managed\n",
					"WHERE country_code = 'DE'\n",
					"ORDER BY city_name\n",
					"LIMIT 5"
				],
				"execution_count": 59
			},
			{
				"cell_type": "markdown",
				"metadata": {
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					"#### Difference of managed and external tables\n",
					"* drop of managed table removes metastore entry and deletes underlying data\n",
					"* drop of external table only removes metastore entry"
				]
			},
			{
				"cell_type": "code",
				"metadata": {
					"collapsed": false
				},
				"source": [
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_managed\")\n",
					"show_table_details(\"flight_data\")\n",
					"\n",
					"print(\"    \")\n",
					"print(\"####################################################################\")\n",
					"print(\"    \")\n",
					"\n",
					"list_files_tree(f\"{bucket}/\",0,2)"
				],
				"execution_count": 61
			},
			{
				"cell_type": "code",
				"source": [
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_new_from_spark\")\n",
					"show_table_details(\"flight_data\")\n",
					"\n",
					"print(\"    \")\n",
					"print(\"####################################################################\")\n",
					"print(\"    \")\n",
					"\n",
					"list_files_tree(f\"{bucket}\",0,2)"
				],
				"execution_count": 62
			},
			{
				"cell_type": "code",
				"source": [
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_registered_from_spark\")\n",
					"show_table_details(\"flight_data\")\n",
					"\n",
					"print(\"####################################################################\")\n",
					"list_files_tree(f\"{bucket}\",0,2)\n",
					""
				],
				"execution_count": 65
			},
			{
				"cell_type": "code",
				"metadata": {
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\n",
					"-- register existing delta file as a table with a new name\n",
					"CREATE EXTERNAL TABLE IF NOT EXISTS flight_data.airport_registered_from_spark\n",
					"USING DELTA\n",
					"LOCATION 'abfss://lht@lhtdata.dfs.core.windows.net/airport.delta';"
				],
				"execution_count": 66
			},
			{
				"cell_type": "code",
				"source": [
					"spark.stop()"
				],
				"execution_count": 24
			},
			{
				"cell_type": "code",
				"source": [
					"# full clean clean up\n",
					"\n",
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport\")\n",
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_registered_from_spark\")\n",
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_new_from_spark\")\n",
					"spark.sql(\"DROP TABLE IF EXISTS flight_data.airport_managed\")\n",
					"\n",
					"\n",
					"show_table_details(\"flight_data\")\n",
					"\n",
					"print(\"####################################################################\")\n",
					"list_files_tree(f\"{bucket}\",0,2)"
				]
			}
		]
	}
}